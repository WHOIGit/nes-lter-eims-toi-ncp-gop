---
title: "NES-LTER EIMS TOI Transect"
author: "Jaxine Wolfe"
date: "Dec 2, 2019"
output: html_document
---

## R Markdown Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# clear workspace for local development
rm(list = ls())

# set environment timezone to UTC
Sys.setenv(TZ = "UTC")

# assign relative path to directory
dir <- "/Users/jaxinewolfe/Documents/WHOI/NESLTER/nes-lter-eims-toi-ncp-gop/"
# set as working directory
setwd(dir)

# define source for functions developed for the EDI packaging workflow
source("edi-utilities.R")

# install necessary libraries
# install.packages("devtools")
# install_github("EDIorg/EMLassemblyline")
# install.packages("R.matlab")

# define R packages to require
libs <- c("tidyverse", "readxl", "lubridate", "devtools", "EMLassemblyline", "EML", "maps", "xml2", "R.matlab")
# load libraries
lapply(libs, require, character.only = TRUE)
```

## Load in Provided Matlab files

```{r}

# store all the names of matlab files
files <- Sys.glob("*.mat")
# apply the readMat function to read in the files
d <- lapply(files, readMat)

# loop through matlab data files
for (i in 1:length(files)) {
  # isolate data in mat file and convert to data frame
  df <- as.data.frame(d[[i]][1])
  # add a utc datetime column 
  df$utc_datetime <- as.POSIXct((df[,1] - 719529)*86400, origin = "1970-01-01", tz = "UTC")
  # assign data to assicated file names
  assign(str_remove(files[i], ".mat"), df)
}
```

## EIMS-TOI-TRANSECT DATA ------------

# Define column headers

Columns are named according to the description of the provided .mat files.

```{r}

# assign column headers
colnames(bottleEn617withoutincubation) <- c("matlab_datetime", "O2_Ar_delta", "O2_Ar_ratio",
                                       "depth", "D17", "d17", "d18", "niskin","utc_datetime")
colnames(RaEn617withbiosat) <- c("matlab_date", "O2_Ar_ratio", "temp", "sal", "lat", "lon", "cum_dist", "biosat", "utc_datetime")

# trim unnecessary fields and rename vars
bottle <- bottleEn617withoutincubation
ra <- RaEn617withbiosat %>% select(-cum_dist)
```

# TOI Underway vs. Bottle

Add a toi_source field to the bottle dataset to clarify whether a bottle was sampled from niskin vs. underway water. Assign underway sampling to a depth of 5m.

```{r}
# define bottle vs underway based on niskin
toi_source <- ifelse(bottle$niskin == 0, 
                     yes = "toi_underway", no = "toi_bottle")
# add categorical column to data
bottle$toi_source <- toi_source

# assign NA to niskin bottle 0
bottle$niskin[bottle$niskin == 0] <- NA_integer_

# assign depths of 0 as 5m if it was an underway sample
for (j in 1:nrow(bottle)) {
  if (bottle$depth[j] == 0 &
      bottle$toi_source[j] == "toi_underway") {
    bottle$depth[j] <- 5
  } else {
    j <- j + 1
    next
  }
}

```

## Correct UTC datetime for bottle samples

Issue: The utc_datetime for bottle-sampled data represents the cast start time, NOT the time at which the bottle was fired. 

Solution: 
  • load in the bottle summary for the appropriate cruise
  • find the associated cast based on nearest time
  • find the time at which the bottle was fired based on cast and niskin
  
```{r}

# read in bottle summary for en617
summary <- read_from_api(type = "summary", cruises = "EN617")

# create column to populate with k from high thoughput
bottle$cast <- NA_integer_

for (i in 1:nrow(bottle)) {
  # store values
  nisk <- bottle$niskin[i]
  nisktime <- bottle$utc_datetime[i]
  
  # skip row if underway
  if (is.na(nisk)) {
    i <- i + 1
    next
  }
  
  # find the index of the nearest datetime
  ind <- which.min(abs(nisktime - summary$date))
  smry_cast <- summary$cast[ind]

  # populate cast column from summary
  bottle$cast[i] <- smry_cast
  
  # store cast to find bottle time
  smry <- summary %>% filter(cast == smry_cast &
                               niskin == nisk)
  
  # case: smry subset is empty
  if (nrow(smry) == 0) {
    print(paste0("Niskin ", nisk, " not found in bottle summary for cast ", smry_cast))
    i <- i + 1
    next
  }
  
  # store bottle time 
  bottle$utc_datetime[i] <- smry$date
}

```

## QA: Checking Data Integrity
```{r}

# are there any bucket samples?
if (any(bottle$depth == 0)) {
  conflicts <- bottle[which(bottle$depth == 0),]
  print(conflicts)
}

# write.csv(conflicts, "bottlesamples_conflict.csv")
# write.csv(summary, "bottlesummary_EN617.csv")

summary %>% filter(cast == 14 | cast == 29)

```

## QA: Map Sampling Locations

Call the map_locs function from edi-utility.R to map the sampling locations. Perform a visual check.

```{r}

# Map Check

# ncplter
map_locs(df = bottle, xvar = "longitude", yvar = "latitude",
         region = "transect", colorvar = NULL)

# underway 02/Ar
map_locs(df = ra, xvar = "lon", yvar = "lat",
         region = "transect", colorvar = NULL)

```

## Column Header Organization
```{r}
# define headers for columns in desired order
bottle_headers <- c("utc_datetime", "matlab_datetime", "toi_source", "cast", "niskin", "depth", "O2_Ar_delta", "O2_Ar_ratio", "D17", "d17", "d18")
ra_headers <- c("utc_datetime", "matlab_date", "lat", "lon", "temp", "sal", "biosat", "O2_Ar_ratio")

# reorder columns as necessary
bottle_edi <- bottle[, bottle_headers]
ra_edi <- ra[, ra_headers]

# write files for upload to EDI
write.csv(bottle_edi, paste0(dir, "/eims-toi-transect/bottleEn617withoutincubation.csv"), 
          row.names = FALSE)
write.csv(ra_edi, file.path(dir, "/eims-toi-transect/RaEn617withbiosat.csv"), 
          row.names = FALSE)

```

## EML Assembly: EIMS-TOI-transect

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input for EML assembly
metadata <- "eims-toi-transect/eims-toi-transect-info"
project_folder <- "eims-toi-transect/"
bottles_file <- "bottleEn617withoutincubation"
ra_file <- "RaEn617withbiosat"
edi_data <- c(bottles_file, ra_file)
file_descriptions <- c("Low frequency oxygen-argon dissolved gas ratios and triple oxygen isotopes", "High frequency oxygen-argon dissolved gas ratios and triple oxygen isotopes")
pkg_id <- "knb-lter-nes.6.1"

# Make EML Templates 
xlsx_to_template(metadata.path = paste0(dir, metadata),
                 output.path = paste0(dir, project_folder),
                 edi.filename = NULL, 
                 rights = "CCBY")
# toi bottle samples
xlsx_to_template(metadata.path = paste0(dir, project_folder, bottles_file), 
                 output.path = paste0(dir, project_folder),
                 edi.filename = bottles_file, 
                 rights = "CCBY")
# underway samples
xlsx_to_template(metadata.path = paste0(dir, project_folder, ra_file), 
                 output.path = paste0(dir, project_folder),
                 edi.filename = ra_file, 
                 rights = "CCBY")

# Data Coverage
# combine the dates for both datasets
# isolate date and geospatial columns for input
date_col <- as.Date(c(ra_edi$utc_datetime,
                      bottle_edi$utc_datetime))
lat_col <- ra_edi$lat
lon_col <- ra_edi$lon
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(path = paste0(dir, project_folder),
         dataset.title = "Oxygen-argon dissolved gas ratios and triple oxygen isotopes from NES-LTER Transect cruises, ongoing since 2018",
         data.table = paste0(edi_data, ".csv"),
         data.table.description = file_descriptions,
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

# Insert Custom Project Node
project_insert(edi_pkg = pkg_id, 
               xml.path = paste0(dir, project_folder))
```


## NCP-GOP-TRANSECT ----------

# Define column headers

Columns are named according to the description of the provided .mat files.

```{r}
# assign column headers
colnames(ncplterEn617) <- c("matlab_date", "O2_Ar_ratio", "temp", "sal", "lat", "lon",
                "cum_dist", "biosat", "ncp", "k","utc_datetime")
colnames(discreteratesEn617) <- c("matlab_date", "lat", "lon", "gop", "ncp",
                                  "ncp_per_gop","utc_datetime")

# trim unnecessary fields and rename vars
ncplter <- ncplterEn617 %>% select(-cum_dist)
rates <- discreteratesEn617
```

## QA: Map Sampling Locations

Call the map_locs function from edi-utility.R to map the sampling locations. Perform a visual check.

```{r}

# Map Check

# ncplter
map_locs(df = ncplter, xvar = "lon", yvar = "lat",
         region = "transect", colorvar = NULL)

# discrete rates
map_locs(df = ncplter, xvar = "lon", yvar = "lat",
         region = "transect", colorvar = NULL)

```

# Column Header Organization
```{r}

# define the desired order of columns
rates_headers <- c("utc_datetime", "matlab_date", "lat", "lon", "gop", "ncp", "ncp_per_gop")
ncp_headers <- c("utc_datetime", "matlab_date", "lat", "lon", "temp", "sal", "biosat", "O2_Ar_ratio", "ncp", "k")

# reorder columns as necessary
rates_edi <- rates[, rates_headers]
ncplter_edi <- ncplter[, ncp_headers]

# write files for upload to EDI
write.csv(rates_edi, 
          paste0(dir, "ncp-gop-transect-summer-2018/discreteratesEn617.csv"), 
          row.names = FALSE)
write.csv(ncplter_edi, paste0(dir, "ncp-gop-transect-summer-2018/ncplterEn617.csv"), 
          row.names = FALSE)
```


## EML Assembly: NCP-GOP-transect

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input for EML assembly
metadata <- "ncp-gop-transect-summer-2018/ncp-gop-transect-info"
project_folder <- "ncp-gop-transect-summer-2018/"
rates_file <- "discreteratesEn617"
ncp_file <- "ncplterEn617"
edi_data <- c(rates_file, ncp_file)
file_descriptions <- c("Low frequency net community production and gross oxygen production", "High frequency net community production and gross oxygen production")
pkg_id <- "knb-lter-nes.7.1"

# Make EML Templates 
xlsx_to_template(metadata.path = paste0(dir, metadata),
                 output.path = paste0(dir, project_folder),
                 edi.filename = NULL, 
                 rights = "CCBY")
# Discrete Rates
xlsx_to_template(metadata.path = paste0(dir, project_folder, rates_file), 
                 output.path = paste0(dir, project_folder),
                 edi.filename = rates_file, 
                 rights = "CCBY")
# Ncplter 
xlsx_to_template(metadata.path = paste0(dir, project_folder, ncp_file), 
                 output.path = paste0(dir, project_folder),
                 edi.filename = ncp_file, 
                 rights = "CCBY")

# Data Coverage
# combine the dates and lat/lon for both datasets
# isolate date and geospatial columns for input
date_col <- as.Date(c(ncplter_edi$utc_datetime, rates_edi$utc_datetime))
lat_col <- c(ncplter_edi$lat, rates_edi$lat)
lon_col <- c(ncplter_edi$lon, rates_edi$lon)
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(path = paste0(dir, project_folder),
         dataset.title = "Net community production and gross oxygen production, based on oxygen-argon ratios and triple oxygen isotopes, from NES-LTER Transect cruise summer 2018",
         data.table = paste0(edi_data, ".csv"),
         data.table.description = file_descriptions,
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

# Insert Custom Project Node
project_insert(edi_pkg = pkg_id, 
               xml.path = paste0(dir, project_folder))
```

